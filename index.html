<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allure Report Viewer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#1e1e1e',
                        darker: '#111111',
                        accent: '#007acc',
                        success: '#28a745',
                        panel: '#252526'
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: #111; }
        body::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        .drag-active {
            border-color: #007acc !important;
            background-color: rgba(0, 122, 204, 0.1) !important;
        }
        .progress-fill { transition: width 0.2s ease; }
    </style>
</head>
<body class="bg-darker text-gray-300 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-panel border-b border-gray-700 h-14 flex items-center justify-between px-4 shadow-md z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-yellow-400 to-orange-600 flex items-center justify-center font-bold text-white text-lg">
                a
            </div>
            <h1 class="text-white font-medium tracking-wide">Allure Report Viewer</h1>
        </div>
        <div>
            <button onclick="resetViewer()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded text-xs transition border border-gray-600 flex items-center gap-2">
                <i class="fas fa-redo-alt"></i> Reset / New Upload
            </button>
        </div>
    </header>

    <!-- Main UI -->
    <main id="main-interface" class="flex-1 flex flex-col items-center justify-center p-4 relative transition-opacity duration-500">
        
        <!-- Drop Zone -->
        <div id="drop-zone" class="border-2 border-dashed border-gray-600 rounded-lg w-full max-w-2xl h-80 flex flex-col items-center justify-center transition-all duration-300 bg-[#1a1a1a]">
            <div class="text-center space-y-4 pointer-events-none p-6">
                <i class="fas fa-folder-open text-6xl text-gray-500 mb-2"></i>
                <h2 class="text-xl font-bold text-gray-200">Drag & Drop FOLDER allure-report Here</h2>
                <p class="text-gray-500 text-sm max-w-md mx-auto">
                    It can be the parent folder or its contents. The system will adjust automatically.
                </p>
            </div>
            <div class="mt-4">
                <input type="file" id="folder-input" webkitdirectory directory multiple class="hidden" />
                <button onclick="document.getElementById('folder-input').click()" class="bg-accent hover:bg-[#005f9e] text-white font-medium py-2 px-8 rounded shadow-lg transition duration-200">
                    Or Select Folder...
                </button>
            </div>
        </div>

        <!-- Status Area -->
        <div id="status-area" class="w-full max-w-2xl mt-8 hidden">
            <div class="flex justify-between text-sm mb-2 font-medium">
                <span id="status-text" class="text-accent">Scanning files...</span>
                <span id="count-text" class="text-gray-400">0 files</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden shadow-inner mb-6">
                <div id="progress-bar" class="progress-fill bg-accent h-3 rounded-full w-0"></div>
            </div>
            <div id="result-box" class="bg-panel border border-gray-600 rounded p-4 flex items-center gap-4 hidden">
                <div id="result-icon" class="text-2xl"></div>
                <div>
                    <h4 id="result-title" class="font-bold text-white"></h4>
                    <p id="result-desc" class="text-gray-400 text-sm"></p>
                </div>
            </div>
            <button id="btn-process" disabled class="w-full mt-6 bg-gray-600 text-gray-400 font-bold py-3 px-4 rounded cursor-not-allowed transition duration-200">
                Wait for scan...
            </button>
        </div>
    </main>

    <!-- Viewer Iframe -->
    <iframe id="viewer-frame" class="w-full h-full border-none hidden bg-white absolute inset-0 top-14 z-20"></iframe>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const statusArea = document.getElementById('status-area');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const countText = document.getElementById('count-text');
        const btnProcess = document.getElementById('btn-process');
        const resultBox = document.getElementById('result-box');
        const folderInput = document.getElementById('folder-input');
        const mainInterface = document.getElementById('main-interface');
        const viewerFrame = document.getElementById('viewer-frame');

        let rawFileCache = new Map(); 
        let normalizedFileCache = new Map();
        let lastUpdateTime = 0;

        // --- 1. Auto-Restore Logic ---
        window.addEventListener('load', checkPreviousSession);

        async function checkPreviousSession() {
            // Cek manual ke IndexedDB sebelum UI muncul
            const request = indexedDB.open("allure-local-drop", 1);
            
            request.onerror = (e) => { console.log("No previous session found."); };
            
            request.onsuccess = async (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("files")) return;

                const transaction = db.transaction(["files"], "readonly");
                const objectStore = transaction.objectStore("files");
                const countRequest = objectStore.count();

                countRequest.onsuccess = async () => {
                    if (countRequest.result > 0) {
                        console.log(`[Auto-Restore] Found ${countRequest.result} files. Restoring session...`);
                        
                        // Sembunyikan UI Drop Zone segera
                        dropZone.classList.add('hidden');
                        statusArea.classList.remove('hidden');
                        statusText.innerText = "Restoring previous session...";
                        progressBar.style.width = "100%";
                        btnProcess.style.display = 'none'; // Sembunyikan tombol proses
                        
                        // Pastikan Service Worker aktif dan muat Iframe
                        if ('serviceWorker' in navigator) {
                            try {
                                await navigator.serviceWorker.register('sw.js');
                                await navigator.serviceWorker.ready;
                                
                                setTimeout(() => {
                                    mainInterface.style.display = 'none';
                                    viewerFrame.classList.remove('hidden');
                                    viewerFrame.src = '__view__/index.html';
                                }, 500);
                            } catch (err) {
                                console.error("SW Registration failed during restore", err);
                                dropZone.classList.remove('hidden'); // Tampilkan ulang jika gagal
                            }
                        }
                    }
                };
            };
        }

        // --- 2. Event Listeners ---
        ['dragenter', 'dragover'].forEach(e => {
            dropZone.addEventListener(e, (ev) => { 
                ev.preventDefault(); ev.stopPropagation(); 
                dropZone.classList.add('drag-active'); 
            });
        });
        ['dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, (ev) => { 
                ev.preventDefault(); ev.stopPropagation(); 
                dropZone.classList.remove('drag-active'); 
            });
        });

        dropZone.addEventListener('drop', async (e) => {
            const items = e.dataTransfer.items;
            if (items && items.length > 0) {
                initScanUI();
                for (let i = 0; i < items.length; i++) {
                    const item = items[i].webkitGetAsEntry();
                    if (item) await traverseFileTree(item);
                }
                finishScanning();
            }
        });

        folderInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                initScanUI();
                Array.from(e.target.files).forEach((file, index) => {
                    rawFileCache.set(file.webkitRelativePath, file);
                    updateProgressUI(index + 1);
                });
                finishScanning();
            }
        });

        function initScanUI() {
            rawFileCache.clear();
            normalizedFileCache.clear();
            dropZone.classList.add('hidden'); 
            statusArea.classList.remove('hidden'); 
            btnProcess.disabled = true;
            statusText.innerText = "Scanning folder structure...";
            progressBar.style.width = '10%';
        }

        async function traverseFileTree(item, path = "") {
            if (item.isFile) {
                const file = await new Promise(resolve => item.file(resolve));
                let fullPath = path + file.name;
                rawFileCache.set(fullPath, file);
                updateProgressUI(rawFileCache.size);
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                const readEntries = async () => {
                    let entries = [];
                    let keepReading = true;
                    while (keepReading) {
                        const batch = await new Promise(resolve => dirReader.readEntries(resolve));
                        if (batch.length > 0) entries = entries.concat(batch);
                        else keepReading = false;
                    }
                    return entries;
                };
                const entries = await readEntries();
                for (const entry of entries) {
                    await traverseFileTree(entry, path + item.name + "/");
                }
            }
        }

        function updateProgressUI(count) {
            const now = Date.now();
            if (now - lastUpdateTime > 100 || count === 1) {
                countText.innerText = `${count.toLocaleString()} files`;
                let currentWidth = parseFloat(progressBar.style.width) || 10;
                if (currentWidth < 90) progressBar.style.width = (currentWidth + 0.5) + '%';
                lastUpdateTime = now;
            }
        }

        function normalizeFilePaths() {
            normalizedFileCache.clear();
            let indexPath = null;
            for (let path of rawFileCache.keys()) {
                if (path.endsWith("index.html") && !path.includes("/index.html/")) {
                    indexPath = path;
                    break;
                }
            }
            if (!indexPath) return false; 
            let pathPrefix = indexPath.substring(0, indexPath.lastIndexOf("index.html"));
            for (const [fullPath, file] of rawFileCache.entries()) {
                if (fullPath.startsWith(pathPrefix)) {
                    const cleanPath = fullPath.substring(pathPrefix.length);
                    normalizedFileCache.set(cleanPath, file);
                }
            }
            return true;
        }

        function finishScanning() {
            progressBar.style.width = '100%';
            statusText.innerText = "Normalizing paths...";
            setTimeout(() => {
                const isSuccess = normalizeFilePaths();
                resultBox.classList.remove('hidden');
                if (isSuccess) {
                    progressBar.classList.replace('bg-accent', 'bg-success');
                    statusText.innerText = "Ready to Process";
                    statusText.classList.add('text-success');
                    document.getElementById('result-icon').innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    document.getElementById('result-title').innerText = "Structure Recognized!";
                    document.getElementById('result-desc').innerText = `${normalizedFileCache.size} files ready.`;
                    btnProcess.disabled = false;
                    btnProcess.classList.remove('bg-gray-600', 'cursor-not-allowed', 'text-gray-400');
                    btnProcess.classList.add('bg-accent', 'hover:bg-[#005f9e]', 'text-white', 'cursor-pointer');
                    btnProcess.innerText = "Open Report Viewer";
                } else {
                    progressBar.style.backgroundColor = '#ef4444';
                    statusText.innerText = "Invalid Folder";
                    statusText.classList.replace('text-accent', 'text-red-500');
                    document.getElementById('result-icon').innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                    document.getElementById('result-title').innerText = "Missing index.html";
                    document.getElementById('result-desc').innerText = "Please drop the correct Allure Report folder.";
                }
            }, 600);
        }

        btnProcess.addEventListener('click', async () => {
            if (!('serviceWorker' in navigator)) return alert("Service Worker not supported");
            btnProcess.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btnProcess.disabled = true;
            try {
                const registration = await navigator.serviceWorker.register('sw.js');
                await navigator.serviceWorker.ready;
                const fileList = {};
                for (const [p, f] of normalizedFileCache.entries()) fileList[p] = f; 
                
                const sendMessage = (target) => target.postMessage({ type: 'FILE_LIST', files: fileList });
                if (navigator.serviceWorker.controller) sendMessage(navigator.serviceWorker.controller);
                else sendMessage(registration.active);

                setTimeout(() => {
                    mainInterface.style.opacity = '0';
                    setTimeout(() => {
                        mainInterface.classList.add('hidden');
                        viewerFrame.classList.remove('hidden');
                        viewerFrame.src = '__view__/index.html';
                    }, 500);
                }, 1500);
            } catch (e) {
                console.error(e);
                alert("Failed to initialize viewer.");
                btnProcess.innerText = "Error";
            }
        });

        async function resetViewer() {
             if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_PERSISTENCE' });
            }
            const regs = await navigator.serviceWorker.getRegistrations();
            for (const reg of regs) await reg.unregister();
            window.location.reload();
        }
    </script>
</body>
</html>